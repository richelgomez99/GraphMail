# GRAPHMAIL Production Transformation - Product Requirements Document

## Executive Summary

Transform GRAPHMAIL from a hackathon prototype into a production-ready, portfolio-quality AI system that extracts verifiable knowledge from email threads with zero hallucination guarantees.

**Current State**: 4/10 production readiness (functional prototype)  
**Target State**: 9/10 production readiness (enterprise-grade system)  
**Timeline**: 4 weeks (175 hours)  
**Business Value**: Portfolio-defining project demonstrating AI/ML engineering excellence

---

## Problem Statement

GRAPHMAIL successfully demonstrates a novel 3-agent verification pipeline for knowledge extraction but has critical production gaps:

- **Security**: OWASP score 3/10 (7 major vulnerabilities)
- **Quality**: 27% code duplication, no tests for Agents 2&3
- **Performance**: 5x slower than target (156s vs <30s for 100 emails)
- **Scalability**: JSON file storage cannot handle production load
- **Maintainability**: Hardcoded values, print statements, 11 redundant demos

---

## Product Vision

Build a **production-grade AI system** that consultants trust for extracting institutional knowledge from emails, demonstrating:
1. Zero-hallucination guarantee through verification layer
2. Enterprise security (OWASP 9/10)
3. 80%+ test coverage with CI/CD
4. 5x performance improvement via async processing
5. Database-backed scalability (PostgreSQL + Neo4j)
6. RESTful API layer for integration
7. Portfolio-quality codebase

---

## Core Requirements

### Phase 1: Foundation & Security (Week 1)

#### FR-1.1: Security Hardening
**Priority**: CRITICAL  
**User Story**: As a security engineer, I need all inputs validated so that prompt injection attacks are prevented.

**Acceptance Criteria**:
- All email inputs sanitized with bleach library
- Email addresses validated with email-validator
- Body text truncated to 5000 chars max
- Rate limiting on all LLM calls (50/min)
- Retry logic with exponential backoff (3 attempts)
- API keys moved to secrets manager (not .env)

**Success Metric**: OWASP score increases from 3/10 to 7/10

---

#### FR-1.2: Code Cleanup
**Priority**: HIGH  
**User Story**: As a developer, I need clean, maintainable code so that I can refactor confidently.

**Acceptance Criteria**:
- Delete 9 redundant demo files (demo_clear.py, demo_final.py, etc.)
- Consolidate features into single demo_dashboard.py
- Code duplication reduced from 27.5% to <5%
- All print() replaced with structured logging (structlog)
- Configuration externalized to settings.py (Pydantic)
- All hardcoded values removed

**Success Metric**: Code duplication <5%, zero print statements in production code

---

#### FR-1.3: Configuration Management
**Priority**: HIGH  
**User Story**: As a DevOps engineer, I need centralized configuration so that deployments are environment-aware.

**Acceptance Criteria**:
- Create src/config/settings.py with Pydantic BaseSettings
- Externalize all magic numbers and paths
- Support .env files per environment (dev, staging, prod)
- Add .env.example with documentation
- Validate configuration at startup

**Success Metric**: Zero hardcoded values in source code

---

### Phase 2: Testing & Quality (Week 2)

#### FR-2.1: Comprehensive Test Suite
**Priority**: CRITICAL  
**User Story**: As a QA engineer, I need 80%+ test coverage so that regressions are caught before production.

**Acceptance Criteria**:
- pytest infrastructure with fixtures for LLM mocking
- 15+ unit tests for Agent 2 (extractor)
- 18+ unit tests for Agent 3 (verifier)
- 8+ integration tests for workflow
- 12+ tests for Trust Score calculation
- CI/CD pipeline runs tests on every PR
- Coverage report generated automatically

**Success Metric**: 80%+ code coverage, all tests passing

---

#### FR-2.2: Error Handling
**Priority**: HIGH  
**User Story**: As a developer, I need structured error handling so that failures are debuggable.

**Acceptance Criteria**:
- Custom exception hierarchy (GraphMailException, LLMException, etc.)
- All exceptions logged with context (structlog)
- Retry logic for transient failures (tenacity)
- Graceful degradation when LLM unavailable
- User-friendly error messages

**Success Metric**: Zero unhandled exceptions in production

---

### Phase 3: Performance (Week 3)

#### FR-3.1: Async Processing
**Priority**: HIGH  
**User Story**: As a user, I need fast processing so that 100 emails complete in <30 seconds.

**Acceptance Criteria**:
- Convert Agent 2 to async (AsyncChatOpenAI)
- Convert Agent 3 to async
- Process projects concurrently (asyncio.gather)
- LangGraph workflow supports async execution
- Benchmark shows 5x speedup (156s → <30s)

**Success Metric**: 100 emails processed in <30 seconds

---

#### FR-3.2: Response Caching
**Priority**: MEDIUM  
**User Story**: As a cost-conscious user, I need LLM response caching so that duplicate queries are free.

**Acceptance Criteria**:
- Redis-backed cache for LLM responses
- Cache key = hash of prompt
- TTL = 1 hour (configurable)
- Cache hit/miss metrics logged
- 90%+ cache hit rate for duplicate data

**Success Metric**: 90% reduction in LLM costs for duplicate queries

---

### Phase 4: Data Layer (Week 4)

#### FR-4.1: Database Integration
**Priority**: HIGH  
**User Story**: As an architect, I need database storage so that the system can scale to 1000+ users.

**Acceptance Criteria**:
- PostgreSQL for relational data (projects, topics, challenges)
- SQLAlchemy ORM with Pydantic models
- Alembic migrations for schema changes
- Migration script from JSON → database
- Database connection pooling
- Neo4j for graph-native queries (optional but recommended)

**Success Metric**: All data stored in database, JSON files deprecated

---

#### FR-4.2: RESTful API
**Priority**: HIGH  
**User Story**: As an integrator, I need REST API endpoints so that I can build on GRAPHMAIL.

**Acceptance Criteria**:
- FastAPI application with OpenAPI docs
- POST /api/v1/extract (async job submission)
- GET /api/v1/jobs/{id} (job status)
- GET /api/v1/projects (list with filters)
- GET /api/v1/projects/{id} (detail view)
- JWT authentication on all endpoints
- Rate limiting per user (100 requests/hour)

**Success Metric**: All features accessible via API

---

## Non-Functional Requirements

### NFR-1: Performance
- **Target**: 100 emails in <30 seconds (5x current)
- **Measurement**: Benchmark tests in CI
- **Budget**: <500ms API response time (excluding LLM wait)

### NFR-2: Scalability
- **Target**: Support 1,000+ concurrent users
- **Approach**: Async processing, database connection pooling, Redis caching
- **Testing**: Load testing with Locust (simulate 1K users)

### NFR-3: Security
- **Target**: OWASP Top 10 score 9/10
- **Requirements**:
  - Input validation on all user data
  - Authentication on all API endpoints
  - Rate limiting to prevent abuse
  - Secrets in AWS Secrets Manager (not .env)
  - SQL injection prevention (SQLAlchemy ORM)
- **Audit**: Penetration testing before production

### NFR-4: Maintainability
- **Target**: <5% code duplication, 80%+ test coverage
- **Standards**:
  - Black code formatting
  - isort import sorting
  - mypy type checking
  - pylint linting (score >8.0)
- **Documentation**: README for every module

### NFR-5: Observability
- **Monitoring**: Sentry error tracking, Datadog metrics
- **Logging**: Structured logs (JSON format) for all events
- **Alerting**: PagerDuty for critical failures
- **Dashboards**: Grafana for performance metrics

---

## Success Criteria

### Technical KPIs

| Metric | Current | Target | Success? |
|--------|---------|--------|----------|
| Test Coverage | 20% | 80%+ | ✅ |
| Processing Speed | 156s | <30s | ✅ |
| OWASP Score | 3/10 | 9/10 | ✅ |
| Code Duplication | 27.5% | <5% | ✅ |
| Production Ready | 4/10 | 9/10 | ✅ |

### Business KPIs

- Portfolio quality: 5/5 stars (demonstrates AI/ML + full-stack)
- Market validation: 10+ beta users within 2 weeks of launch
- Cost efficiency: <$0.03 per email processed
- Uptime: 99.5%+ availability in first month

---

## Technical Architecture

### Core Innovation (Preserve)
**3-Agent Verification Pipeline**:
1. **Agent 1 (Parser)**: Deterministic email cleaning (no LLM)
2. **Agent 2 (Extractor)**: LLM-powered hypothesis generation
3. **Agent 3 (Verifier)**: LLM-powered fact verification

**Zero-Hallucination Guarantee**: Every fact must have evidence

### New Architecture (Add)
**API Layer**: FastAPI with async endpoints  
**Data Layer**: PostgreSQL (relational) + Neo4j (graph)  
**Cache Layer**: Redis for LLM responses  
**Job Queue**: Celery for background processing (future)

---

## Constraints & Assumptions

### Constraints
- **Budget**: $30K for development ($150/hr × 175 hours)
- **Timeline**: 4 weeks (40 hours/week)
- **Team Size**: 1 full-time engineer
- **Technology**: Python 3.11, FastAPI, PostgreSQL, Redis

### Assumptions
- LLM API costs remain stable (~$0.005/1K tokens)
- OpenAI/Anthropic APIs have 99.9% uptime
- Neo4j can be added later (not blocking)
- UI overhaul can be phase 2 (Next.js, 4 additional weeks)

---

## Risks & Mitigations

### Risk 1: LLM API Changes
**Probability**: Medium  
**Impact**: High  
**Mitigation**: Abstract LLM interface, version pinning, fallback provider

### Risk 2: Database Migration Issues
**Probability**: Medium  
**Impact**: High  
**Mitigation**: Comprehensive backup, dry-run migrations, rollback scripts

### Risk 3: Performance Degradation
**Probability**: Low  
**Impact**: Medium  
**Mitigation**: Benchmark before/after every change, performance tests in CI

### Risk 4: Scope Creep
**Probability**: High  
**Impact**: Medium  
**Mitigation**: Strict adherence to 4-week roadmap, phase 2 for extras

---

## Out of Scope (Phase 2)

- UI overhaul to Next.js (4 additional weeks)
- Multi-tenancy support
- Real-time collaboration features
- Advanced analytics dashboard
- Webhook notifications
- Email provider integrations (Gmail, Outlook)
- Natural language query interface

---

## Development Principles (Constitution)

**Article I: Zero-Hallucination Principle**  
Every fact must have proof. No extracted fact enters the graph without verifiable evidence.

**Article II: Sequential Processing Integrity**  
Respect temporal order. Email processing must preserve chronological order.

**Article III: Graph-First Architecture**  
The graph is the source of truth. All data stored as queryable knowledge graph.

**Article IV: LLM Verification Layer**  
Trust but verify. LLM outputs are hypotheses until verified.

**Article V: Evidence Traceability**  
Audit trail for every claim. Users can trace any fact back to source.

**Article VI: Test-Driven Development**  
No code without tests. Minimum 80% coverage required.

**Article VII: API-First Design**  
Build for integration. Core functionality exposed via clean API.

**Article VIII: Security by Default**  
Fail secure, not open. Conservative defaults, authentication required.

**Article IX: Performance Budgets**  
Speed is a feature. Must meet minimum throughput requirements.

---

## Delivery Milestones

### Milestone 1: Foundation (Week 1, Day 5)
- ✅ Security vulnerabilities fixed
- ✅ Code cleanup complete (-2,500 LOC)
- ✅ Logging and configuration in place
- ✅ 12 quick wins implemented

### Milestone 2: Quality (Week 2, Day 10)
- ✅ 80%+ test coverage achieved
- ✅ CI/CD pipeline operational
- ✅ All tests passing
- ✅ Error handling standardized

### Milestone 3: Performance (Week 3, Day 15)
- ✅ Async processing implemented
- ✅ 5x speedup validated
- ✅ Caching operational
- ✅ Benchmarks passing

### Milestone 4: Production (Week 4, Day 20)
- ✅ Database migration complete
- ✅ API endpoints functional
- ✅ Authentication working
- ✅ Deployed to staging

### Final: Production Ready (Day 28)
- ✅ All acceptance criteria met
- ✅ Security audit passed
- ✅ Performance benchmarks validated
- ✅ Documentation updated
- ✅ Ready for portfolio

---

## Appendix: Reference Documents

All detailed specifications available in `speckit-prep/`:
- `AUDIT_REPORT.md` - Complete technical audit
- `SECURITY_VULNERABILITIES.md` - Security analysis
- `REFACTORING_PLAN.md` - Implementation guide
- `TASK_PRIORITIES.md` - Ordered task list
- `TEST_COVERAGE_GAPS.md` - Testing strategy
- `UI_UX_IMPROVEMENTS.md` - UI transformation (phase 2)
- `constitution.md` - Development principles
- `BREAKING_CHANGES.md` - Migration guide

---

**Document Version**: 1.0  
**Last Updated**: November 17, 2025  
**Owner**: GRAPHMAIL Development Team  
**Status**: APPROVED FOR IMPLEMENTATION

